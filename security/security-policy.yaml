# FaaS Platform Security Policy Configuration
apiVersion: v1
kind: SecurityPolicy
metadata:
  name: faas-platform-security
  version: "1.0"
  description: "Comprehensive security policy for FaaS Platform production deployment"

# Network Security Configuration
network:
  # Firewall rules
  firewall:
    default_policy: "deny"
    allowed_ports:
      - port: 22
        protocol: tcp
        source: "10.0.0.0/8"  # Internal networks only for SSH
        description: "SSH access from internal networks"
      - port: 8080
        protocol: tcp
        source: "0.0.0.0/0"
        description: "FaaS API HTTP"
      - port: 8443
        protocol: tcp
        source: "0.0.0.0/0"
        description: "FaaS API HTTPS"
      - port: 9090
        protocol: tcp
        source: "10.0.0.0/8"  # Internal monitoring only
        description: "Metrics endpoint"

  # TLS Configuration
  tls:
    min_version: "1.2"
    cipher_suites:
      - "ECDHE-RSA-AES256-GCM-SHA384"
      - "ECDHE-RSA-AES128-GCM-SHA256"
      - "ECDHE-RSA-AES256-SHA384"
      - "ECDHE-RSA-AES128-SHA256"
    certificate_rotation_days: 30
    hsts_enabled: true
    hsts_max_age: 31536000  # 1 year

# Container Security
container_security:
  # Runtime security
  runtime:
    apparmor_profile: "faas-container"
    seccomp_profile: "/etc/docker/seccomp.json"
    no_new_privileges: true
    read_only_root: true
    non_root_user: true

  # Resource limits
  limits:
    memory_max_mb: 4096
    cpu_max_cores: 4
    execution_timeout_max_ms: 600000  # 10 minutes
    disk_quota_mb: 1024
    network_bandwidth_mbps: 100

  # Image security
  images:
    scan_required: true
    vulnerability_threshold: "high"
    allowed_registries:
      - "docker.io"
      - "quay.io"
      - "gcr.io"
      - "your-private-registry.com"
    prohibited_tags:
      - "latest"
      - "dev"
      - "test"

  # Privileged operations (prohibited)
  prohibited_capabilities:
    - "SYS_ADMIN"
    - "NET_ADMIN"
    - "SYS_PTRACE"
    - "SYS_MODULE"
    - "DAC_OVERRIDE"

# Authentication and Authorization
auth:
  # API Key requirements
  api_keys:
    min_length: 32
    rotation_required_days: 90
    rate_limit_per_key: 1000  # requests per minute

  # Access controls
  rbac:
    enabled: true
    policies:
      - role: "developer"
        permissions:
          - "execute:basic"
          - "metrics:read"
          - "health:read"
        rate_limit: 500

      - role: "admin"
        permissions:
          - "*"
        rate_limit: 2000

      - role: "readonly"
        permissions:
          - "metrics:read"
          - "health:read"
        rate_limit: 100

# Data Protection
data_protection:
  # Encryption
  encryption:
    at_rest: true
    in_transit: true
    key_rotation_days: 30

  # Data retention
  retention:
    execution_logs_days: 30
    metrics_data_days: 90
    audit_logs_days: 365

  # Sensitive data handling
  pii_protection:
    enabled: true
    redact_logs: true
    anonymize_metrics: true

# Audit and Monitoring
audit:
  # Logging requirements
  logging:
    level: "INFO"
    structured: true
    retention_days: 365

    events:
      - "api_access"
      - "execution_start"
      - "execution_complete"
      - "execution_failure"
      - "auth_failure"
      - "rate_limit_exceeded"
      - "security_violation"

  # Monitoring
  monitoring:
    real_time_alerts: true
    anomaly_detection: true
    threat_detection: true

    alert_conditions:
      - metric: "failed_executions_rate"
        threshold: 0.05  # 5%
        window: "5m"

      - metric: "auth_failures_rate"
        threshold: 10  # per minute
        window: "1m"

      - metric: "resource_usage_cpu"
        threshold: 0.8  # 80%
        window: "5m"

      - metric: "resource_usage_memory"
        threshold: 0.8  # 80%
        window: "5m"

# Compliance Requirements
compliance:
  standards:
    - "SOC2"
    - "ISO27001"
    - "GDPR"

  controls:
    - id: "AC-2"
      description: "Account Management"
      implementation: "RBAC with API key rotation"

    - id: "AU-2"
      description: "Audit Events"
      implementation: "Comprehensive audit logging"

    - id: "SC-7"
      description: "Boundary Protection"
      implementation: "Firewall and network segmentation"

    - id: "SI-3"
      description: "Malicious Code Protection"
      implementation: "Container image scanning"

# Incident Response
incident_response:
  automated_responses:
    - trigger: "security_violation"
      action: "block_source_ip"
      duration: "1h"

    - trigger: "high_error_rate"
      action: "enable_enhanced_logging"
      duration: "30m"

    - trigger: "resource_exhaustion"
      action: "throttle_requests"
      percentage: 50

  escalation:
    - level: 1
      condition: "auth_failures > 100/min"
      notify: ["security-team@company.com"]

    - level: 2
      condition: "security_violation"
      notify: ["security-team@company.com", "ciso@company.com"]

    - level: 3
      condition: "data_breach_suspected"
      notify: ["security-team@company.com", "ciso@company.com", "legal@company.com"]

# Security Testing
testing:
  # Automated security testing
  automated:
    vulnerability_scanning: "daily"
    penetration_testing: "monthly"
    dependency_scanning: "on_commit"

  # Manual testing
  manual:
    red_team_exercises: "quarterly"
    security_reviews: "release"
    compliance_audits: "annual"