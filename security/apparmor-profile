# AppArmor profile for FaaS container security
# This profile restricts container capabilities and access

#include <tunables/global>

profile faas-container flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>

  # Allow basic capabilities needed for applications
  capability setuid,
  capability setgid,
  capability chown,
  capability dac_override,
  capability fowner,
  capability fsetid,
  capability kill,
  capability setpcap,
  capability net_bind_service,
  capability net_raw,

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_ptrace,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_time,
  deny capability sys_nice,
  deny capability sys_resource,
  deny capability sys_tty_config,
  deny capability mknod,
  deny capability lease,
  deny capability audit_write,
  deny capability audit_control,
  deny capability setfcap,
  deny capability mac_override,
  deny capability mac_admin,
  deny capability syslog,
  deny capability wake_alarm,
  deny capability block_suspend,

  # Filesystem access restrictions
  # Allow read access to common system directories
  /etc/** r,
  /lib/** r,
  /lib64/** r,
  /usr/** r,
  /bin/** r,
  /sbin/** r,

  # Allow limited write access to application directories
  /app/** rw,
  /tmp/** rw,
  /var/tmp/** rw,

  # Allow access to standard files and devices
  /dev/null rw,
  /dev/zero r,
  /dev/random r,
  /dev/urandom r,
  /dev/tty rw,
  /dev/pts/** rw,

  # Deny access to sensitive system areas
  deny /boot/** rwklx,
  deny /sys/** w,
  deny /proc/sys/** w,
  deny /proc/sysrq-trigger w,
  deny /proc/mem r,
  deny /proc/kmem r,
  deny @{PROC}/sys/kernel/core_pattern w,
  deny @{PROC}/sys/kernel/modprobe w,
  deny @{PROC}/kcore r,

  # Network restrictions
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,

  # Deny raw sockets and packet sockets
  deny network packet,
  deny network raw,

  # Mount restrictions
  deny mount,
  deny umount,
  deny pivot_root,

  # Process restrictions
  deny ptrace,
  deny signal (send) peer=unconfined,

  # Module loading restrictions
  deny @{PROC}/sys/kernel/modprobe w,
  deny /lib/modules/** w,

  # Kernel keyring restrictions
  deny keyctl,

  # Time modification restrictions
  deny /proc/sys/kernel/clock/** w,

  # Seccomp restrictions
  deny /proc/*/seccomp w,

  # Container escape prevention
  deny /var/run/docker.sock rw,
  deny /var/lib/docker/** rw,
  deny /etc/docker/** w,

  # Prevent access to host processes
  deny /proc/*/root/** rwklx,
  deny /proc/*/exe r,
  deny /proc/*/cmdline r,
  deny /proc/*/environ r,

  # Logging and monitoring allowances
  /dev/log w,
  /var/log/** w,

  # Allow signal handling for graceful shutdown
  signal (receive) set=(term, kill, int, quit, hup, usr1, usr2),
  signal (send) set=(term, kill, int, quit, hup, usr1, usr2) peer=faas-container,

  # Allow standard program execution
  /usr/bin/** ix,
  /bin/** ix,
  /usr/local/bin/** ix,

  # Python specific allowances (commonly used)
  /usr/bin/python* ix,
  /usr/bin/pip* ix,
  /usr/local/bin/python* ix,

  # Node.js specific allowances
  /usr/bin/node ix,
  /usr/bin/npm ix,

  # Shell allowances (limited)
  /bin/sh ix,
  /bin/bash ix,
  /bin/dash ix,

  # Standard library access
  /usr/lib/python*/** r,
  /usr/local/lib/python*/** r,
  /usr/lib/node_modules/** r,
}