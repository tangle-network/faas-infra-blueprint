# Dockerfile for testing Firecracker and CRIU on macOS via Docker
FROM ubuntu:22.04

# Install base dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    pkg-config \
    libssl-dev \
    # CRIU dependencies
    criu \
    # Firecracker dependencies (we'll run in non-KVM mode)
    wget \
    # Docker CLI for nested Docker operations
    docker.io \
    # Additional utilities
    iproute2 \
    iptables \
    ca-certificates \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain nightly
ENV PATH="/root/.cargo/bin:${PATH}"

# Download Firecracker (even though it won't fully work without KVM, we can test the integration)
RUN wget https://github.com/firecracker-microvm/firecracker/releases/download/v1.4.0/firecracker-v1.4.0-x86_64.tgz \
    && tar -xzf firecracker-v1.4.0-x86_64.tgz \
    && mv release-v1.4.0-x86_64/firecracker-v1.4.0-x86_64 /usr/local/bin/firecracker \
    && mv release-v1.4.0-x86_64/jailer-v1.4.0-x86_64 /usr/local/bin/jailer \
    && rm -rf release-v1.4.0-x86_64 firecracker-v1.4.0-x86_64.tgz \
    && chmod +x /usr/local/bin/firecracker /usr/local/bin/jailer

# Create directories for Firecracker
RUN mkdir -p /var/lib/firecracker/kernel \
    && mkdir -p /var/lib/firecracker/rootfs \
    && mkdir -p /var/lib/faas/kernel

# Download a minimal kernel for Firecracker (even if we can't run it)
RUN wget https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/x86_64/kernels/vmlinux.bin \
    -O /var/lib/faas/kernel/vmlinux.bin || true

# Set up working directory
WORKDIR /workspace

# Copy the project files
COPY . .

# Build the project
RUN cargo +nightly build --package faas-executor --release

# Create a test runner script
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "=== System Information ==="\n\
uname -a\n\
echo ""\n\
\n\
echo "=== CRIU Version ==="\n\
criu --version || echo "CRIU not available"\n\
echo ""\n\
\n\
echo "=== Firecracker Version ==="\n\
firecracker --version || echo "Firecracker not available"\n\
echo ""\n\
\n\
echo "=== Docker Version ==="\n\
docker version || echo "Docker not available"\n\
echo ""\n\
\n\
echo "=== Running Tests ==="\n\
\n\
# Run CRIU tests (should work in container with right capabilities)\n\
echo ">> CRIU Tests"\n\
cargo +nightly test --package faas-executor --test criu_tests -- --ignored --nocapture || true\n\
\n\
# Run mock Firecracker tests (won\'t have KVM but can test integration)\n\
echo ">> Firecracker Integration Tests"\n\
cargo +nightly test --package faas-executor --lib firecracker -- --nocapture || true\n\
\n\
# Run platform executor tests\n\
echo ">> Platform Executor Tests"\n\
cargo +nightly test --package faas-executor --lib platform::executor -- --ignored --nocapture || true\n\
\n\
echo "=== Tests Complete ===" \n\
' > /run_tests.sh && chmod +x /run_tests.sh

CMD ["/run_tests.sh"]