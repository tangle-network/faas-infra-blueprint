# Minimal test image - fast build for Docker-only tests
FROM rust:1.75

# Non-interactive
ENV DEBIAN_FRONTEND=noninteractive

# Install only Docker CLI
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    docker.io \
    && rm -rf /var/lib/apt/lists/*

# Install nightly Rust
RUN rustup toolchain install nightly && \
    rustup default nightly

WORKDIR /workspace

# Copy only what's needed for building
COPY Cargo.toml Cargo.lock ./
COPY crates/faas-executor/Cargo.toml ./crates/faas-executor/
COPY crates/faas-common/Cargo.toml ./crates/faas-common/
COPY faas-lib/Cargo.toml ./faas-lib/

# Create placeholder files for dependency compilation
RUN mkdir -p crates/faas-executor/src crates/faas-common/src faas-lib/src && \
    echo "fn main() {}" > crates/faas-executor/src/main.rs && \
    echo "pub fn dummy() {}" > crates/faas-common/src/lib.rs && \
    echo "pub fn dummy() {}" > faas-lib/src/lib.rs

# Build dependencies (cached)
RUN cargo +nightly build --package faas-executor && \
    rm -rf crates/*/src faas-lib/src

# Copy source
COPY . .

# Quick build
RUN cargo +nightly build --package faas-executor

# Test runner
CMD ["cargo", "+nightly", "test", "--package", "faas-executor", "--test", "docker_integration", "--", "--ignored"]